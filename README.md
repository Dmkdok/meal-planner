# Раскладка Продуктов

Веб-приложение для планирования питания и расчета необходимого количества продуктов для походов.

## Описание

Приложение позволяет:
- Создавать и управлять планами питания (раскладками)
- Добавлять дни, приемы пищи и продукты в раскладку
- Рассчитывать необходимое количество продуктов для похода с учетом количества дней и людей
- Визуализировать результаты расчета в удобной таблице

## Архитектура

После рефакторинга приложение использует модульную архитектуру:

### Структура проекта
```
meal-planner/
├── raskladka/
│   ├── __init__.py          # Инициализация Flask приложения
│   ├── models.py            # Модели базы данных
│   ├── views.py             # Контроллеры (маршруты)
│   ├── services.py          # Бизнес-логика (сервисный слой)
│   ├── utils.py             # Утилиты и вспомогательные функции
│   ├── static/
│   │   └── style.css        # Стили для страниц авторизации
│   └── templates/
│       ├── index.html       # Главная страница с раскладкой и калькулятором
│       ├── login.html       # Страница входа
│       ├── register.html    # Страница регистрации
│       └── edit_day.html    # Страница редактирования дня
├── run.py                   # Точка входа приложения
├── requirements.txt         # Зависимости Python
└── README.md               # Документация
```

### Слои приложения

1. **Модели (models.py)**
   - `User` - пользователи системы
   - `MealPlan` - планы питания
   - `Day` - дни в плане
   - `Meal` - приемы пищи
   - `Product` - продукты

2. **Сервисы (services.py)**
   - `CalculationService` - расчет продуктов на основе раскладки
   - `MealPlanService` - управление планами питания
   - `DayService` - управление днями
   - `MealService` - управление приемами пищи
   - `ProductService` - управление продуктами

3. **Контроллеры (views.py)**
   - Обработка HTTP запросов
   - Валидация входных данных
   - Вызов сервисов
   - Возврат ответов

4. **Утилиты (utils.py)**
   - Форматирование веса
   - Валидация данных

## Ключевые изменения после рефакторинга

### 1. Перенос логики калькулятора на бекенд
- **Было**: Вся логика расчета находилась в JavaScript на фронтенде
- **Стало**: Логика расчета перенесена в `CalculationService` на бекенде
- **Преимущества**: 
  - Безопасность (логика защищена от модификации)
  - Производительность (расчеты выполняются на сервере)
  - Переиспользование (API может использоваться другими клиентами)

### 2. Введение сервисного слоя
- **Было**: Бизнес-логика смешана с контроллерами
- **Стало**: Отдельный слой сервисов для бизнес-логики
- **Преимущества**:
  - Разделение ответственности
  - Легкость тестирования
  - Переиспользование логики

### 3. Улучшенная валидация
- Добавлена валидация входных данных в API
- Проверка типов и диапазонов значений
- Информативные сообщения об ошибках

### 4. Новый API endpoint
- `POST /calculate` - расчет продуктов на основе раскладки
- Принимает: `plan_id`, `trip_days`, `people_count`
- Возвращает: структурированные данные для отображения

## Установка и запуск

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Запустите приложение:
```bash
python run.py
```

3. Откройте браузер и перейдите по адресу: `http://localhost:5000`

## Использование

1. **Регистрация/Вход**: Создайте аккаунт или войдите в существующий
2. **Создание раскладки**: Создайте новый план питания
3. **Добавление дней**: Добавьте дни в раскладку
4. **Добавление продуктов**: Добавьте продукты в приемы пищи
5. **Расчет**: Перейдите на вкладку "Калькулятор" и укажите параметры похода
6. **Результат**: Получите детальный расчет необходимых продуктов

## Технологии

- **Backend**: Flask, SQLAlchemy, Flask-Login, Flask-Bcrypt
- **Frontend**: HTML5, CSS3, JavaScript (ES6+)
- **База данных**: SQLite
- **Архитектура**: Модульная с разделением на слои

## API Endpoints

### POST /calculate
Расчет продуктов на основе раскладки

**Параметры:**
```json
{
  "plan_id": 1,
  "trip_days": 7,
  "people_count": 3
}
```

**Ответ:**
```json
{
  "status": "success",
  "data": {
    "results": [...],
    "summary": {...},
    "meal_types_by_day": [...],
    "product_meal_usage": {...}
  }
}
```

## Безопасность

- Аутентификация пользователей
- Проверка прав доступа к данным
- Валидация всех входных данных
- Защита от SQL-инъекций через ORM
